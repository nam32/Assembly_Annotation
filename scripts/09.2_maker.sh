#!/bin/bash

# This script runs the MAKER gene annotation pipeline with MPI parallelism, using 50 tasks for faster processing.
# After the annotation process, it merges the output GFF3 files and FASTA sequences into unified files for downstream analyses.
#
# **Workflow**:
# 1. Configures the environment and ensures necessary paths and permissions are set.
# 2. Runs the MAKER annotation pipeline within an Apptainer (Singularity) container.
# 3. Post-processes the outputs by merging GFF3 annotations and FASTA sequences.
#
# **Requirements**:
# - MAKER must be accessible via an Apptainer container.
# - RepeatMasker, AUGUSTUS, and other dependencies must be properly configured.
# - MPI must be loaded for parallel execution.
#
# **Output**:
# - `assembly.all.maker.gff`: Combined GFF3 file with sequence data.
# - `assembly.all.maker.noseq.gff`: Combined GFF3 file without sequence data.
# - Merged FASTA sequence file.
#
# Reference:
# - MAKER documentation: http://www.yandell-lab.org/software/maker.html

#SBATCH --time=24:00:00
#SBATCH --mem=64G
#SBATCH --partition=pibu_el8
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=50
#SBATCH --job-name=Maker
#SBATCH --output=Maker_gene_annotation_%j.out
#SBATCH --error=Maker_gene_annotation_%j.err

# Running MAKER gene annotation pipeline with 50 parallel tasks
# Post-processing the output files by merging the GFF3 annotations and FASTA sequences.

module load OpenMPI/4.1.1-GCC-10.3.0
module load AUGUSTUS/3.4.0-foss-2021a

#mkdir -p /data/users/tjanjumratsang/assembly_annotation_course/gene_annotation_directory

COURSEDIR="/data/courses/assembly-annotation-course/CDS_annotation"
WORKDIR=/data/users/tjanjumratsang/assembly_annotation_course/gene_annotation_directory
REPEATMASKER_DIR="/data/courses/assembly-annotation-course/CDS_annotation/softwares/RepeatMasker"

# Set paths for MAKER control files
maker_opts=${WORKDIR}/maker_opts.ctl
maker_bopts=${WORKDIR}/maker_bopts.ctl
maker_evm=${WORKDIR}/maker_evm.ctl
maker_exe=${WORKDIR}/maker_exe.ctl

# Make control files executable
cd $WORKDIR
chmod +x *.ctl

# Add RepeatMasker to PATH for accessibility during the MAKER pipeline
export PATH=$PATH:"/data/courses/assembly-annotation-course/CDS_annotation/softwares/RepeatMasker"

# Run the MAKER gene annotation pipeline inside an Apptainer container with MPI parallelism
mpiexec --oversubscribe -n 50 apptainer exec \
 --bind $SCRATCH:/TMP --bind $COURSEDIR --bind $AUGUSTUS_CONFIG_PATH --bind $REPEATMASKER_DIR \
 ${COURSEDIR}/containers/MAKER_3.01.03.sif \
 maker -mpi --ignore_nfs_tmp -TMP /TMP ${maker_opts} ${maker_bopts} ${maker_evm} ${maker_exe}
 
# Output preparation for final annotation files

MAKERBIN="$COURSEDIR/softwares/Maker_v3.01.03/src/bin" 

# Merge GFF3 files generated by MAKER and save with new filenames
$MAKERBIN/gff3_merge -s -d assembly.maker.output/assembly_master_datastore_index.log > assembly.all.maker.gff 
$MAKERBIN/gff3_merge -n -s -d assembly.maker.output/assembly_master_datastore_index.log > assembly.all.maker.noseq.gff 

# Merge the FASTA files generated by MAKER into a single file
$MAKERBIN/fasta_merge -d assembly.maker.output/assembly_master_datastore_index.log -o assembly
